---
title: "Analyzing Risk with ICD-10 Data"
author: "Sidharth Jain"
date: "May 25, 2016"
output: html_document
---

To determine the liability of patients in Medicare, CMS uses the HCC (Hierarchical Condition Categories) to determine risk scores.  This scoring was extended upon implementation of the Affordable Care Act, to create the HHS-HCC Risk Adjustment Model.  Here, I attempt to simulate the risk scoring algorithm using simulated claims data, in hopes to be able to extend this algorithm for larger data sets of real claims data from patients.  

Risk adjustment calculations are significant in terms of cost analysis and reduction for health insurance companies and accountable care organizations.  High risk individuals tend to be the most expensive.  Identifying these individuals and providing preventive care may significantly reduce the cost of providing healthcare, as well as reducing risk transfer (more on that to follow).


### Data and Descriptions

To begin, I first load in the necessary data.  I am using the most current ICD-10 to HCC key available from CMS.  

```{r}
hcc2icd10 <- read.csv("~/Documents/Valera/RiskAnalysis/HHS_HCC_TO_ICD10.csv")
head(hcc2icd10)
```

The data contains the following information: 

- ICD-10 Diagnosis Code
- Description of Code
- Age limitations for Code
- HCC Code
- Other specific data about code use

We will be generating simulated patient data using ICD-10 codes of patients with 2 or more (up to 5)  comorbidities, and assessing risk for these patients.

For now, I'm only dealing with adults between the ages of 21-64 out of convenience and rapid prototyping, but this algorithm can be expanded to cover infants (0-1), children (2-20), and seniors (65+).

```{r}
### Generating sample data:
patient.ids <- sample(1:10000, size=1000, replace=FALSE)

patient.ages <- sample(21:80, size=1000, replace=T)

patient.sexes <- as.factor(sample(c("M", "F"), size=1000, replace=T)) # 1 if male, 2 if female

icd10s <- unique(hcc2icd10$ICD10)

# everyone has 1 comorbidity
morbidity1 <- sample(icd10s, size=1000, replace=T)  
# everyone has 2nd comorbidity
morbidity2 <- sample(icd10s, size=1000, replace=T) 

# 75% have 3rd comorbidity
morbidity3 <- sapply(sample(icd10s, size=1000, replace=T), function(x){
    sample(c(x, NA), size=1, prob=c(0.75, 0.25))
})

# 25% have 4th comorbidity
morbidity4 <- sapply(sample(icd10s, size=1000, replace=T), function(x){
    sample(c(x, NA), size=1, prob=c(0.25, 0.75))
})

# 5% have 5th comorbidity
morbidity5 <- sapply(sample(icd10s, size=1000, replace=T), function(x){
    sample(c(x, NA), size=1, prob=c(0.05, 0.95))
})

# Simulated Data:
PatientData <- data.frame(patient.ids, patient.sexes, patient.ages, morbidity1, morbidity2, morbidity3, morbidity4, morbidity5)

(head(PatientData))
```

Now that the data has been simulated, I can use known HCC Risk Calculations to determine risk on each of these patients.  In order to do so, each value must be mapped with the corresponding liability value to determine whether or not the risk assessment of the patient is higher or lower than the normal.

To calculate age/sex liability, we use the following function with conditionals.

### Age/Sex Risk Analysis
(Assuming Platinum Plan liability with HCC-HMS population extrapolation)
```{r}
M <- c(rep(0.258, 4), sapply(c(0.278, 0.338, 0.413, 0.487, 0.581, 0.737, 0.863, 1.028), rep, 5))

F <- c(rep(0.433, 4), sapply(c(0.548, 0.656, 0.76, 0.839, 0.878, 1.013, 1.054, 1.156), rep, 5))

AgeANDSex2Risk.table <-
    data.frame(M, F, row.names = 21:64)

AgeANDSex2Risk <- function(x){
    sex <- x[2]
    age <- x[3]
    return(AgeANDSex2Risk.table[age, sex])
}
```

### Diagnosis-based Risk Adjustment

```

## Applying risk adjustment formula to simulated data
```{r}
age.sex_risk <- apply(PatientData, MARGIN = 1, FUN = AgeANDSex2Risk)


```


